# ROM Parity Tasks Generated by AGENT.md

_Generated: 2025-09-29 following Phase 3 analysis workflow_

## CRITICAL ARCHITECTURAL INTEGRATION TASKS

### 1. Reset System (confidence 0.38) - LastObj/LastMob State Tracking

**[P0] Implement ROM LastObj/LastMob state tracking in reset_handler**

- **FILES**: `mud/spawning/reset_handler.py`, `mud/loaders/reset_loader.py`
- **ISSUE**: Missing LastObj/LastMob index state tracking causing reset validation mismatches and incorrect P command targeting
- **C_REF**: `src/db.c:1009-1108` (load_resets maintains LastMob/LastObj context for P/G/E commands)
- **ACCEPTANCE**: `pytest tests/test_area_loader.py::test_midgaard_reset_validation` passes; P commands correctly target LastObj
- **EVIDENCE**:
  - C: `src/db.c:1009-1108` (pLastMob/pLastObj tracking across reset commands)
  - PY: `mud/spawning/reset_handler.py:258-589` (apply_resets lacks persistent LastObj/LastMob state)
  - TEST: Integration test for LastObj P command targeting with cross-area validation

**[P1] Integrate reset area update cycle with ROM timing**

- **FILES**: `mud/spawning/reset_handler.py`, `mud/world/game_loop.py`
- **ISSUE**: Area age increment and reset scheduling not integrated with main game loop tick system
- **C_REF**: `src/db.c:1590-1620` (area_update called from update.c with age tracking)
- **ACCEPTANCE**: Areas reset at ROM intervals (age 15 for normal, age 3 for empty areas)
- **EVIDENCE**:
  - C: `src/db.c:1590-1620` (area_update with age-based reset scheduling)
  - PY: `mud/spawning/reset_handler.py:700-728` (reset_tick exists but not integrated)
  - TEST: Time-based area reset integration test

### 2. Movement System (confidence 0.55) - Encumbrance Integration

**[P0] Integrate encumbrance limits with inventory management**

- **FILES**: `mud/world/movement.py`, `mud/world/inventory.py`
- **ISSUE**: Encumbrance checks in movement not updated when inventory changes; carry limits not enforced consistently
- **C_REF**: `src/act_move.c:75-95` (move_char checks can_carry_w before allowing movement)
- **ACCEPTANCE**: Movement blocked when carry_weight exceeds limits; limits updated on get/drop/give
- **EVIDENCE**:
  - C: `src/act_move.c:75-95` (encumbrance blocking with carry_weight checks)
  - PY: `mud/world/movement.py:225-230` (basic encumbrance check present but not integrated)
  - TEST: Encumbrance integration test with inventory changes

**[P1] Complete portal traversal with follower cascading**

- **FILES**: `mud/world/movement.py`, `mud/commands/movement.py`
- **ISSUE**: Portal traversal follower cascading incomplete; enter command integration gaps
- **C_REF**: `src/act_move.c:127-184` (move_char follower recursion applies to all movement types)
- **ACCEPTANCE**: Followers follow through portals; enter command fully integrated with movement system
- **EVIDENCE**:
  - C: `src/act_move.c:127-184` (universal follower cascading for all movement)
  - PY: `mud/world/movement.py:372-396` (portal movement exists, cascading present)
  - TEST: `tests/test_movement.py::test_followers_enter_portal` (already exists, needs validation)

### 3. Help System (confidence 0.70) - Command Topic Integration

**[P0] Complete help command dispatcher integration**

- **FILES**: `mud/commands/help.py`, `mud/systems/dispatcher.py`
- **ISSUE**: Help command topic generation not fully integrated with command dispatcher for dynamic help
- **C_REF**: `src/act_info.c:1540-1580` (do_help function with command lookup and topic generation)
- **ACCEPTANCE**: `help commands` generates dynamic command list; help topics integrate with dispatcher
- **EVIDENCE**:
  - C: `src/act_info.c:1540-1580` (do_help with dynamic command topic generation)
  - PY: `mud/commands/help.py:45-89` (\_generate_command_help exists but dispatcher integration incomplete)
  - TEST: Dynamic help command generation integration test

**[P1] Implement trust-based help topic filtering**

- **FILES**: `mud/commands/help.py`, `mud/systems/help.py`
- **ISSUE**: Trust level filtering for help topics not fully implemented; admin commands not properly gated
- **C_REF**: `src/act_info.c:1540-1580` (do_help filters topics by character trust level)
- **ACCEPTANCE**: Low-trust players cannot see immortal help topics; help filtering by trust level
- **EVIDENCE**:
  - C: `src/act_info.c:1540-1580` (trust-based help topic filtering)
  - PY: `mud/commands/help.py:90-120` (trust gating present but not comprehensive)
  - TEST: Trust level help filtering integration test

### 4. Area Format Loader (confidence 0.74) - State Validation

**[P0] Implement cross-area reference validation**

- **FILES**: `mud/loaders/area_loader.py`, `mud/loaders/reset_loader.py`
- **ISSUE**: Cross-area vnum references not validated during load; missing validation for area boundary violations
- **C_REF**: `src/db.c:441-520` (load_area with vnum range validation and area boundary checks)
- **ACCEPTANCE**: Cross-area references rejected with meaningful errors; area boundary violations caught at load time
- **EVIDENCE**:
  - C: `src/db.c:441-520` (area vnum validation with boundary enforcement)
  - PY: `mud/loaders/area_loader.py:105-130` (duplicate vnum check exists but cross-area validation incomplete)
  - TEST: Cross-area reference validation integration test

**[P1] Complete format edge case error handling**

- **FILES**: `mud/loaders/area_loader.py`, `mud/loaders/base_loader.py`
- **ISSUE**: Edge cases in area format parsing not handled; malformed area files can cause silent failures
- **C_REF**: `src/db.c:441-520` (load_area with comprehensive error handling for malformed entries)
- **ACCEPTANCE**: Malformed area files rejected with specific error messages; no silent failures
- **EVIDENCE**:
  - C: `src/db.c:441-520` (comprehensive area format error handling)
  - PY: `mud/loaders/area_loader.py:23-88` (basic validation present but edge cases incomplete)
  - TEST: Malformed area file error handling integration test

## INTEGRATION TEST REQUIREMENTS

Each task requires integration tests in `tests/integration/` following this pattern:

```python
class Test{Subsystem}Integration:
    """Integration tests for {subsystem} architectural integration."""

    def test_{specific_integration_point}(self):
        """Test {specific ROM parity requirement}."""
        # Setup ROM-equivalent scenario
        # Execute integration behavior
        # Assert ROM parity maintained
```

## TASK PRIORITY MATRIX

| Subsystem            | P0 Tasks                 | P1 Tasks           | Integration Risk | ROM Parity Gap |
| -------------------- | ------------------------ | ------------------ | ---------------- | -------------- |
| resets               | LastObj/LastMob tracking | Area update cycle  | High             | Critical       |
| movement_encumbrance | Encumbrance integration  | Portal cascading   | Medium           | Important      |
| help_system          | Dispatcher integration   | Trust filtering    | Low              | Minor          |
| area_format_loader   | Cross-area validation    | Edge case handling | Medium           | Important      |

## EXECUTION NOTES FOR AGENT.EXECUTOR.md

1. **Evidence Validation**: Each task includes C/Python/TEST evidence pointers for ROM parity verification
2. **Integration Focus**: Tasks address architectural integration gaps, not individual function fixes
3. **Test Requirements**: Integration tests required to validate architectural behavior
4. **Confidence Impact**: Completing these tasks should raise confidence scores above 0.80 threshold

---

_These tasks generated by AGENT.md Phase 3 analysis workflow targeting the 4 incomplete subsystems identified by confidence tracking._
