# QuickMUD Development Guide for AI Agents

## üö® IMPORTANT: Command Parity Gap Discovered (Dec 2025)

**Current Status**: 115/181 ROM commands implemented (63.5%)

**Critical Issue**: Previous "100% parity" claim was based on backend mechanics testing, not player-facing commands. Many essential commands are missing or broken.

**See**: [Command Parity Reality Check](#Ô∏è-command-parity-reality-check-december-2025) section below for details.

**Action Items**:
1. Review [COMMAND_PARITY_AUDIT.md](COMMAND_PARITY_AUDIT.md) - Full gap analysis
2. Follow [IMPLEMENTATION_PLAN.md](IMPLEMENTATION_PLAN.md) - Phased roadmap
3. Run `pytest tests/integration/` to see current state
4. Implement P0 commands first (24 commands for basic gameplay)

---

## ü§ñ Autonomous Mode (ENABLED)

**When explicitly directed by user**, agent may enter autonomous task completion mode:

### Activation Criteria
- User explicitly says "start autonomous mode" or gives clear directive to "complete all tasks"
- User specifies scope (P0 only, P0+P1, or all tasks)
- User sets time limit and error handling policy

### Autonomous Workflow
1. ‚úÖ Create comprehensive todo list from ARCHITECTURAL_TASKS.md
2. üîÑ Execute tasks sequentially without waiting for approval
3. üî® Fix errors immediately before proceeding to next task
4. ‚úÖ Run full test suite after each major task
5. üìä Run `scripts/test_data_gatherer.py` to verify ROM parity
6. üìù Update ARCHITECTURAL_TASKS.md and PROJECT_COMPLETION_STATUS.md
7. üéØ Stop at time limit or scope completion

### Quality Gates (MANDATORY)
- **After each task**: Run acceptance tests specified in ARCHITECTURAL_TASKS.md
- **After each task**: Run full test suite (200+ tests) to catch regressions
- **After all tasks**: Run `scripts/test_data_gatherer.py` for final parity verification
- **On any test failure**: Fix immediately before proceeding

### Stopping Conditions
- All tasks in scope complete
- Time limit reached
- Unrecoverable error (after 3 fix attempts)
- User interruption

**Current Session**: Autonomous mode ACTIVE
- **Scope**: P0 + P1 tasks (7 tasks)
- **Time Limit**: 2 hours
- **Error Policy**: Fix immediately
- **Started**: 2025-12-19 13:30 CST

---

## Specialized Agent Files

QuickMUD uses specialized agent files for different types of work:

### 1. **AGENT.md** - Architectural Analysis Agent
- **Purpose**: Identify and fix architectural integration gaps
- **Focus**: Subsystems with confidence < 0.92
- **Output**: P0/P1 architectural tasks with ROM C evidence
- **Use When**: Subsystems need structural improvements
- **Status**: Primary agent for architectural work

### 2. **FUNCTION_COMPLETION_AGENT.md** - Function Coverage Agent
- **Purpose**: Implement remaining 57 unmapped utility functions
- **Focus**: Helper functions, not architectural gaps
- **Output**: Function implementations with ROM parity
- **Use When**: Want to increase function coverage from 83.1% to 95%+
- **Scope**: ~12 hours work for 57 functions
- **Priority**: Optional (core ROM functionality already complete)

### 3. **AGENT.EXECUTOR.md** - Task Execution Agent
- **Purpose**: Execute tasks generated by AGENT.md
- **Focus**: Implementation of specific P0/P1 tasks
- **Output**: Code changes, tests, completion reports
- **Use When**: Tasks are defined and ready for implementation
- **Status**: Used for autonomous task completion

### Agent Selection Guide

| Goal | Use This Agent | Notes |
|------|----------------|-------|
| Fix subsystem integration issues | [AGENT.md](AGENT.md) | Start here for architectural work |
| Implement missing helper functions | [FUNCTION_COMPLETION_AGENT.md](FUNCTION_COMPLETION_AGENT.md) | Optional, 57 low-priority functions |
| Execute defined tasks autonomously | [AGENT.EXECUTOR.md](AGENT.EXECUTOR.md) | After tasks are generated |
| Verify behavioral parity | [AGENT.md](AGENT.md) Phase 3 | Runtime differential testing |

### When to Use FUNCTION_COMPLETION_AGENT.md

‚úÖ **Use when:**
- Want to maximize function coverage (83.1% ‚Üí 95%+)
- Need mobprog helpers for complex mob behaviors
- Want complete OLC helper utilities
- Time available for ~12 hours of implementation work

‚ùå **Skip when:**
- Core ROM gameplay is priority (already 83.1% complete)
- Prefer behavioral verification over function count
- Limited time (runtime testing has higher ROI)

The 57 remaining functions are utilities and helpers, not core ROM mechanics.

---

## Task Tracking (CRITICAL - READ FIRST!)

QuickMUD uses **THREE** task tracking systems. **ALWAYS update the appropriate file when completing work.**

### 1. TODO.md - High-Level Project Phases ‚úÖ COMPLETE
- **Purpose**: 14 major project steps (data models ‚Üí networking ‚Üí deployment)
- **Status**: ALL STEPS COMPLETE - use for historical reference only
- **DO NOT UPDATE** - this tracks completed infrastructure work

### 2. ARCHITECTURAL_TASKS.md - ROM Parity Integration Tasks ‚úÖ COMPLETE
- **Purpose**: Architecture-level integration gaps identified by AGENT.md analysis
- **Status**: ALL 7 P0/P1 tasks completed (2025-12-19)
- **When to Update**: Historical reference only - DO NOT UPDATE
- **Use Instead**: `docs/parity/ROM_PARITY_FEATURE_TRACKER.md` for remaining work
- **Completed Tasks**:
  - ‚úÖ `[P0] Implement ROM LastObj/LastMob state tracking in reset_handler`
  - ‚úÖ `[P0] Integrate encumbrance limits with inventory management`
  - ‚úÖ `[P0] Complete help command dispatcher integration`
  - ‚úÖ `[P0] Implement cross-area reference validation`
  - ‚úÖ `[P1] Complete portal traversal with follower cascading`
  - ‚úÖ `[P1] Implement trust-based help topic filtering`
  - ‚úÖ `[P1] Complete format edge case error handling`

**‚úÖ LEGACY FILE** - Use `docs/parity/ROM_PARITY_FEATURE_TRACKER.md` for active work

### 3. docs/parity/ROM_PARITY_FEATURE_TRACKER.md - Complete ROM Parity Feature List üéØ PRIMARY
- **Purpose**: Comprehensive tracking of ALL ROM 2.4b C features needed for 100% parity
- **Status**: Single source of truth for remaining parity work
- **When to Update**: When implementing any ROM parity features
- **Coverage**: 100% feature mapping (advanced mechanics, not just basic functionality)
- **Priority Levels**: P0-P3 matrix for implementation planning
- **Features**: Detailed breakdown of every missing ROM feature with C references

**üéØ PRIMARY SOURCE OF TRUTH** - **USE THIS FILE** for:
- Identifying next parity work
- Checking implementation status
- Planning development roadmap
- Tracking progress toward 100% ROM parity

### 4. PROJECT_COMPLETION_STATUS.md - Subsystem Confidence Tracking
- **Purpose**: Tracks 27 subsystems by confidence score (0.00-1.00)
- **Updated By**: `scripts/test_data_gatherer.py` (automated) or manual analysis
- **When to Update**: After major subsystem work or test additions
- **Confidence Levels**:
  - ‚úÖ Complete: ‚â•0.80 (production-ready)
  - ‚ö†Ô∏è Needs Work: <0.80 (incomplete)

**Check this file** to identify which subsystems need attention.

### Task Tracking Workflow

**When starting work:**
1. Check `docs/parity/ROM_PARITY_FEATURE_TRACKER.md` for specific parity features to implement
2. Check `PROJECT_COMPLETION_STATUS.md` for subsystem confidence levels
3. Use `CURRENT_STATUS_SUMMARY.md` for overall project overview

**When completing work:**
1. ‚úÖ Mark features complete in `docs/parity/ROM_PARITY_FEATURE_TRACKER.md`
2. Update subsystem confidence in `PROJECT_COMPLETION_STATUS.md` if applicable
3. Run `pytest` to verify no regressions
4. Update `CURRENT_STATUS_SUMMARY.md` for major milestones

**Example completion format:**
```markdown
### 1. Reset System (confidence 0.38) - LastObj/LastMob State Tracking

**‚úÖ [P0] Implement ROM LastObj/LastMob state tracking in reset_handler** - COMPLETED 2025-12-19

- **FILES**: `mud/spawning/reset_handler.py`, `mud/loaders/reset_loader.py`
- **COMPLETED BY**: [Your completion notes here]
- **TESTS ADDED**: `tests/test_reset_state_tracking.py` (15 tests)
- **ACCEPTANCE**: ‚úÖ `pytest tests/test_area_loader.py::test_midgaard_reset_validation` passes
```

### Quick Reference: Which File to Update?

| Work Type | Update File |
|-----------|-------------|
| **ROM parity feature implementation** | `docs/parity/ROM_PARITY_FEATURE_TRACKER.md` üéØ **PRIMARY** |
| Subsystem confidence changed significantly | `PROJECT_COMPLETION_STATUS.md` |
| Session summary or milestone | `CURRENT_STATUS_SUMMARY.md` |
| Builder tools or OLC work | Individual completion reports (e.g., `BUILDER_TOOLS_COMPLETION.md`) |
| Architectural integration (HISTORICAL) | `ARCHITECTURAL_TASKS.md` ‚úÖ **COMPLETE** |
| General todos (infrastructure) | `TODO.md` (rarely - mostly complete) |

---

## ‚ö†Ô∏è Command Parity Reality Check (December 2025)

### The Discovery

**Previous Claim**: 100% ROM parity based on backend mechanics  
**Reality**: **63.5% command coverage** (115/181 ROM commands implemented)

**What Went Wrong**: Tests verified **backend mechanics** work, not **player-facing commands**

### Critical Findings

| Category | Status | Impact |
|----------|--------|--------|
| **Backend Mechanics** | ‚úÖ 83.1% function coverage | Combat, movement, skills work |
| **Player Commands** | ‚ùå 63.5% command coverage | Players get "Huh?" for basic actions |
| **Unit Tests** | ‚úÖ 1435+ tests passing | Components work in isolation |
| **Integration Tests** | ‚ùå Most workflows broken | End-to-end player experience fails |

**Example**: Follower mechanics are 100% tested and working, but `follow` command doesn't exist!

### Missing Critical Commands (P0)

**Cannot play without these**:
- `consider <mob>` - Assess difficulty (CRITICAL)
- `follow <target>` - Follow NPCs/players (CRITICAL)
- `group <target>` - Form groups (CRITICAL)
- `give <item> <target>` - Give items (CRITICAL for quests)
- `look <target>` - **BROKEN** (ignores args, shows room instead of target)
- `tell <mob>` - **BROKEN** (can't tell to mobs)
- `open`/`close`/`lock`/`unlock` - Door interaction
- `flee` - Escape combat
- `rescue` - Protect group members

### Reference Documents

See these files for complete analysis and implementation plan:

1. **[COMMAND_PARITY_AUDIT.md](COMMAND_PARITY_AUDIT.md)** - Full 181 command audit
2. **[IMPLEMENTATION_PLAN.md](IMPLEMENTATION_PLAN.md)** - Phased implementation roadmap
3. **[tests/integration/README.md](tests/integration/README.md)** - Integration test guide

### Integration Test Framework

**New test suite**: `tests/integration/` - Tests complete player workflows

```bash
# Run integration tests (shows what's actually broken)
pytest tests/integration/ -v

# Run only passing tests
pytest tests/integration/ -v -m "not skip"

# See progress tracking
cat tests/integration/README.md
```

**Key insight**: Unit tests verify `can_see_character()` works. Integration tests verify `look mob` actually calls it.

### Recommended Workflow for Command Implementation

**Phase 1: Fix Immediate Bugs** (30 minutes)
1. Fix `look <target>` - Edit `mud/commands/inspection.py` line 117
2. Fix `tell <mob>` - Search for mobs in room, not just online players

**Phase 2: Implement P0 Commands** (2-3 days)
- See [IMPLEMENTATION_PLAN.md](IMPLEMENTATION_PLAN.md) for detailed roadmap
- Each command includes ROM C reference, time estimate, test cases

**Phase 3: Run Integration Tests** (ongoing)
```bash
# After implementing each command
pytest tests/integration/test_player_npc_interaction.py -v

# Track progress
pytest tests/integration/ --co  # See all tests
pytest tests/integration/ -v    # Run all tests
```

### Success Criteria (Revised)

| Milestone | Commands | Integration Tests | Player Experience |
|-----------|----------|-------------------|-------------------|
| **Current** | 115/181 (63.5%) | 2/26 passing | "Huh?" for basic actions |
| **Phase 1** | 139/181 (75%) | 10/26 passing | Can play basic game |
| **Phase 2** | 157/181 (85%) | 20/26 passing | Full combat/groups work |
| **True 100%** | 181/181 (100%) | 26/26 passing | ROM C player experience |

**Before claiming "100% parity"**:
- [ ] All P0 commands implemented (24 commands)
- [ ] All P1 commands implemented (18 commands)
- [ ] Integration tests pass for complete player workflows
- [ ] New player can: create char, visit shop, buy items, group up, fight mobs
- [ ] No "Huh?" for common ROM commands

---

## Build/Lint/Test Commands
```bash
# Run all tests (200+ tests, ~16s)
pytest

# Run integration tests (end-to-end workflows)
pytest tests/integration/ -v

# Run single test file
pytest tests/test_combat.py

# Run specific test function
pytest tests/test_combat.py::test_rescue_checks_group_permission

# Run tests matching keyword
pytest -k "movement"

# Run with coverage (CI requirement: ‚â•80%)
pytest --cov=mud --cov-report=term --cov-fail-under=80

# Test all commands (comprehensive command validation)
python3 test_all_commands.py

# Lint with ruff
ruff check .
ruff format --check .

# Type check with mypy (strict on specific modules)
mypy mud/net/ansi.py mud/security/hash_utils.py --follow-imports=skip
```

**Three Testing Levels**:
1. **Unit Tests** (`tests/test_*.py`) - Verify components work in isolation
2. **Integration Tests** (`tests/integration/`) - Verify complete player workflows work
3. **Command Tests** (`test_all_commands.py`) - Verify all 287 commands can be called without import/module errors

**Always run all three** when implementing new commands!

### Command Validation Script

The `test_all_commands.py` script provides comprehensive command testing:

```bash
# Run comprehensive command test
python3 test_all_commands.py

# What it tests:
#  - All 287 registered commands
#  - Import resolution (no missing modules)
#  - Command execution (no crashes)
#  - Return type validation (all return strings)
#  - Categorized error reporting

# Expected results:
#  ‚úÖ 277/287 commands working (96.5%)
#  ‚ùå 10 commands need game state (rooms, boards, etc.)
```

**Use this script to:**
- Verify no import errors after adding new commands
- Test commands work without starting the full MUD server
- Catch broken imports before committing
- Validate command parity is maintained

## Code Style Guidelines

**Imports:** `from __future__ import annotations` first; stdlib, third-party, local (alphabetical within groups)  
**Types:** Strict annotations throughout; use `TYPE_CHECKING` guard for circular imports  
**Naming:** `snake_case` functions/vars, `PascalCase` classes, `UPPER_CASE` constants, `_prefix` for private  
**Docstrings:** Required for public functions; include ROM C source references for parity code  
**Error handling:** Defensive programming with try/except; specific exceptions where possible  
**Formatting:** Line length 120 (ruff/black), double quotes, 4-space indent

## ROM Parity Rules (CRITICAL)
- **RNG:** Use `rng_mm.number_*` family, NEVER `random.*` in combat/affects  
- **Math:** Use `c_div`/`c_mod` for C integer semantics, NEVER `//` or `%`  
- **Enums:** ALWAYS use `PlayerFlag`/`CommFlag`/etc enums, NEVER hardcode flag values
  - **Wrong:** `PLR_AUTOLOOT = 0x00000800` (bit 11)
  - **Correct:** `PlayerFlag.AUTOLOOT` (1 << 4 = 0x0010, bit 4)
  - **Why:** ROM C enum values use bit shifts; hardcoded hex values will be wrong
  - **Note:** `PlayerFlag.COLOUR` is in `act` field, NOT `comm` field
- **Comments:** Reference ROM C sources (e.g., `# mirroring ROM src/fight.c:one_hit`)  
- **Tests:** Golden files derived from ROM behavior; assert exact C semantics  
- See `port.instructions.md` for exhaustive parity rules

## Test Fixtures (from conftest.py)
```python
movable_char_factory(name, room_vnum, points=100)  # Test character with movement
movable_mob_factory(vnum, room_vnum, points=100)   # Test mob with movement  
object_factory(proto_kwargs)                       # Object without placement
place_object_factory(room_vnum, vnum=..., proto_kwargs=...)  # Object in room
portal_factory(room_vnum, to_vnum, closed=False)   # Portal object
ensure_can_move(entity, points=100)                # Setup movement fields
```

## CI Workflow
Pre-commit hooks run `black`, `ruff --fix`, and fixture lint. CI runs: help data drift check, ruff/flake8 lint, mypy type check (select modules), pytest with 80% coverage, telnet tests (Linux only). All must pass.
