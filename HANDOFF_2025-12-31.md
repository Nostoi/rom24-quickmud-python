# Session Handoff: December 31, 2025

**Session Completed**: Spell Affects Persistence Integration Tests  
**Next Agent Should Start**: Character Creation Workflow Tests (Priority 1)

---

## üìä Current Project Status

### Integration Test Coverage: ‚úÖ **71% Complete** (14/21 systems)

**Test Results**:
- **Integration Tests**: 164/182 passing (90.1% pass rate) ‚úÖ
- **Overall Test Suite**: 1435/1436 tests passing (99.93%)
- **P1 Systems Complete**: 11/13 (85%)

**Recent Achievement**:
- ‚úÖ Spell Affects Persistence: 17/21 tests passing (81% coverage)
- ‚úÖ Fixed stat modifier stacking bug
- ‚úÖ Implemented sanctuary visual indicators
- üìÑ Full report: `SESSION_SUMMARY_2025-12-31_SPELL_AFFECTS_STACKING.md`

---

## üéØ WHERE TO START (For Next Agent)

### Step 1: Read the Priority Guide

**üö® CRITICAL**: Open this file and read the "NEXT RECOMMENDED WORK" section:

üìÑ **[docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md](docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md#-next-recommended-work-start-here)**

This section contains:
- ‚úÖ **Top 3 priorities** with time estimates
- ‚úÖ **Why each task matters** (impact explanation)
- ‚úÖ **What files to modify**
- ‚úÖ **What tests to write**
- ‚úÖ **Acceptance criteria** for completion
- ‚úÖ **Detailed section references** for implementation guidance

**Pro Tip**: The guide is structured to be self-contained. You don't need to read this handoff document beyond this point - just go straight to the tracker!

---

### Step 2: Pick a Priority

**Recommended Order** (based on impact and complexity):

#### ü•á Priority 1: Character Creation Workflow (HIGH - 2-3 hours)
- **File**: `tests/integration/test_new_player_workflow.py`
- **Current**: 40% coverage (basic flow only)
- **Need**: ~10 tests for complete new player experience
- **Impact**: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (ensures new players can start playing)
- **See**: [Tracker Section](docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md#priority-1-character-creation-workflow-tests-high---2-3-hours)

#### ü•à Priority 2: Weather & Time System (MEDIUM - 1-2 hours)
- **File**: `tests/integration/test_game_loop.py`
- **Current**: 50% coverage (no player visibility)
- **Need**: ~8 tests for broadcasts and day/night effects
- **Impact**: ‚≠ê‚≠ê‚≠ê‚≠ê (makes world feel alive)
- **See**: [Tracker Section](docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md#priority-2-weather--time-system-tests-medium---1-2-hours)

#### ü•â Priority 3: Mob AI Enhancement (MEDIUM - 2 hours)
- **File**: `tests/integration/test_game_loop.py`
- **Current**: 60% coverage (missing home return, memory)
- **Need**: ~6 tests for sentinel/aggro/memory behaviors
- **Impact**: ‚≠ê‚≠ê‚≠ê‚≠ê (mobs behave like ROM)
- **See**: [Tracker Section](docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md#priority-3-mob-ai-enhancement-tests-medium---2-hours)

---

### Step 3: Before Writing Tests

**‚ö†Ô∏è MANDATORY READING** (if doing integration tests):

üìÑ **[docs/ROM_PARITY_VERIFICATION_GUIDE.md](docs/ROM_PARITY_VERIFICATION_GUIDE.md)**

**Why This Matters**:
- Documents common ROM parity pitfalls (integer division, RNG, pulse timing)
- Explains the 3 levels of parity verification
- Contains case studies from actual bugs we fixed
- **Prevents you from writing tests that pass but miss parity violations!**

**Time Investment**: 10-15 minutes to read, saves hours of debugging

---

### Step 4: Implementation Workflow

```bash
# 1. Read the detailed section in the tracker
cat docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md | less
# Search for your priority (e.g., "/Character Creation")

# 2. Run existing tests to understand current state
pytest tests/integration/test_new_player_workflow.py -v

# 3. Write new tests following existing patterns
# Look at similar tests for examples:
# - tests/integration/test_spell_affects_persistence.py (session 2 example)
# - tests/integration/test_group_combat.py (session 1 example)

# 4. Run your new tests
pytest tests/integration/test_new_player_workflow.py::test_your_new_test -xvs

# 5. Fix any issues discovered
# (This is where most of the work happens!)

# 6. Verify no regressions
pytest tests/integration/ -q

# 7. Update the tracker
# - Update coverage % in the summary table
# - Mark tests as complete in the detailed section
# - Update "Last Updated" date

# 8. Create session summary
# Follow pattern from SESSION_SUMMARY_2025-12-31_SPELL_AFFECTS_STACKING.md
```

---

## üìö Key Documentation Files

### Essential Reading (In Order)

1. **[AGENTS.md](AGENTS.md)** - Agent guidelines and current focus (START HERE)
2. **[docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md](docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md)** - Integration test priorities and status
3. **[docs/ROM_PARITY_VERIFICATION_GUIDE.md](docs/ROM_PARITY_VERIFICATION_GUIDE.md)** - How to verify ROM parity correctly
4. **[SESSION_SUMMARY_2025-12-31_SPELL_AFFECTS_STACKING.md](SESSION_SUMMARY_2025-12-31_SPELL_AFFECTS_STACKING.md)** - Most recent session example

### Reference Documentation

- **[docs/parity/ROM_C_SUBSYSTEM_AUDIT_TRACKER.md](docs/parity/ROM_C_SUBSYSTEM_AUDIT_TRACKER.md)** - ROM C source audit status
- **[docs/parity/ROM_PARITY_FEATURE_TRACKER.md](docs/parity/ROM_PARITY_FEATURE_TRACKER.md)** - ROM feature implementation status
- **[PROJECT_COMPLETION_STATUS.md](PROJECT_COMPLETION_STATUS.md)** - Subsystem confidence scores

---

## üîß Quick Commands Reference

```bash
# Run all integration tests
pytest tests/integration/ -v

# Run specific test file
pytest tests/integration/test_new_player_workflow.py -v

# Run specific test
pytest tests/integration/test_new_player_workflow.py::test_specific_test -xvs

# Check integration test pass rate
pytest tests/integration/ -q | tail -1

# Run full test suite (should stay ~99.93%)
pytest

# Lint code
ruff check .
ruff format --check .

# Update integration test coverage tracker
vim docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md
```

---

## üìà Success Metrics

**For Character Creation (Priority 1)**:
- [ ] 10 new tests added to `test_new_player_workflow.py`
- [ ] Coverage increases from 40% ‚Üí 80%+
- [ ] Integration test count: 164 ‚Üí 174 passing
- [ ] No regressions (all existing tests still pass)
- [ ] Tracker updated with new coverage %
- [ ] Session summary created

**Session is "Complete" when**:
- All new tests passing
- Documentation updated
- Session summary created
- No regressions introduced

---

## üéì Lessons from Previous Session

### What Went Well
1. ‚úÖ **Feature Discovery** - Found dispel magic was already implemented
2. ‚úÖ **Quick Wins** - Unskipping tests where features exist
3. ‚úÖ **Bug Fixing** - Fixed stat stacking bug in 10 minutes
4. ‚úÖ **Documentation** - Updated tracker immediately after work

### What to Avoid
1. ‚ùå **Don't assume tests are wrong** - Verify ROM C source first
2. ‚ùå **Don't skip documentation updates** - Update tracker as you go
3. ‚ùå **Don't batch test runs** - Run tests frequently to catch issues early

### Best Practices
1. ‚úÖ **Read ROM C source** - Verify expected behavior before fixing
2. ‚úÖ **Run tests after each change** - Catch regressions immediately
3. ‚úÖ **Update tracker incrementally** - Don't save all updates for the end
4. ‚úÖ **Follow existing test patterns** - Look at recent tests for examples

---

## üö® Common Pitfalls (From ROM Parity Guide)

1. **Integer Division** - Use `c_div()` not `//`
2. **RNG** - Use `rng_mm.number_*` not `random.*`
3. **Pulse Timing** - Verify PULSE constants match ROM C
4. **Enum Hardcoding** - Use enums, not hardcoded values
5. **Test Isolation** - Fresh instances for probabilistic tests

**See Full List**: [docs/ROM_PARITY_VERIFICATION_GUIDE.md](docs/ROM_PARITY_VERIFICATION_GUIDE.md)

---

## üéØ Your Mission (If You Choose to Accept)

**Goal**: Increase integration test coverage from 71% to 75%+ by completing Priority 1 (Character Creation)

**Time Estimate**: 2-3 hours

**Impact**: High - New players can start playing without issues

**Difficulty**: Medium - Well-scoped, clear requirements

**Starting Point**: üìÑ [Integration Test Coverage Tracker - Next Work Section](docs/parity/INTEGRATION_TEST_COVERAGE_TRACKER.md#-next-recommended-work-start-here)

**Good luck, and happy testing!** üöÄ

---

## üìû Need Help?

- **Integration Test Examples**: `tests/integration/test_spell_affects_persistence.py` (just completed!)
- **Test Fixtures**: `tests/conftest.py` - Use `movable_char_factory()`, `place_object_factory()`, etc.
- **ROM C Source**: `src/` directory - Verify expected behavior
- **Session Pattern**: `SESSION_SUMMARY_2025-12-31_SPELL_AFFECTS_STACKING.md` - Follow this format

---

**Last Updated**: December 31, 2025, 9:45 PM  
**Session Completed By**: Sisyphus (OhMyOpenCode Agent)  
**Next Agent**: Start with Priority 1 from Integration Test Coverage Tracker
